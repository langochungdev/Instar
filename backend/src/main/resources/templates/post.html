<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo post & upload nhiều media</title>
</head>
<body>
<h2>Tạo bài viết mới + upload nhiều ảnh/video</h2>
<form id="createPostForm">
    <label>Nội dung: <input type="text" name="content" required></label><br><br>
    <label>Access Token (JWT):<br>
        <input type="text" id="token" style="width: 500px">
    </label><br><br>
    <button type="submit">Tạo bài viết</button>
</form>
<br>
<form id="uploadForm" enctype="multipart/form-data" style="display: none;">
    <label>Chọn nhiều ảnh/video:
        <input type="file" name="files" accept="image/*,video/*" multiple required>
    </label><br><br>
    <button type="submit">Upload file(s)</button>
</form>
<div id="result"></div>
<script>
    let createdPostId = null;

    document.getElementById('createPostForm').onsubmit = async function(e) {
        e.preventDefault();
        const content = this.elements['content'].value;
        const token = document.getElementById('token').value.trim();
        if (!token) { alert('Nhập JWT token!'); return; }
        const res = await fetch('http://localhost:8080/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ content: content })
        });
        const data = await res.json();
        if (data.id) {
            createdPostId = data.id;
            document.getElementById('result').innerText = 'Tạo bài viết thành công, postId = ' + data.id;
            document.getElementById('uploadForm').style.display = '';
        } else {
            document.getElementById('result').innerText = 'Tạo bài viết thất bại: ' + (data.message || JSON.stringify(data));
        }
    };

    document.getElementById('uploadForm').onsubmit = async function(e) {
        e.preventDefault();
        if (!createdPostId) {
            alert('Bạn cần tạo bài viết trước!');
            return;
        }
        const token = document.getElementById('token').value.trim();
        const filesInput = this.elements['files'];
        const files = filesInput.files;
        const formData = new FormData();
        formData.append('postId', createdPostId);
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]); // tên phải đúng "files"
        }
        const res = await fetch('http://localhost:8080/api/post-media/upload', {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        const txt = await res.text();
        document.getElementById('result').innerText += '\nKết quả upload:\n' + txt;
    }
</script>
</body>
</html>
