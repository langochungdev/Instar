<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test Realtime Chat (Instar)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css"/>
</head>
<body class="p-4">
<div class="container">
    <h3>Test Chat Realtime Instar</h3>
    <div class="row mb-2">
        <div class="col">
            <label>UserId: <input id="userId" class="form-control" value="1"></label>
        </div>
        <div class="col">
            <label>ChatId: <input id="chatId" class="form-control" value="1"></label>
        </div>
    </div>
    <button id="connectBtn" class="btn btn-success mb-2">Kết nối</button>
    <div id="status"></div>
    <div id="messages" style="height:300px;overflow:auto;background:#eee;padding:10px;"></div>
    <div class="row mt-2">
        <div class="col-9"><input id="messageInput" class="form-control" placeholder="Nhập nội dung..."></div>
        <div class="col-3"><button id="sendBtn" class="btn btn-primary w-100">Gửi</button></div>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;

    document.getElementById('connectBtn').onclick = function () {
        let userId = document.getElementById('userId').value;
        let chatId = document.getElementById('chatId').value;
        let socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            connected = true;
            document.getElementById('status').innerText = 'Đã kết nối';
            let topic = '/topic/chat/' + chatId + '/user/' + userId;
            stompClient.subscribe(topic, function (msg) {
                let body = JSON.parse(msg.body);
                let messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML += `<div><b>${body.senderId}:</b> ${body.content} <small>${body.createdAt}</small></div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        });
    };

    document.getElementById('sendBtn').onclick = function () {
        if (!connected) {
            alert('Chưa kết nối');
            return;
        }
        let userId = parseInt(document.getElementById('userId').value);
        let chatId = parseInt(document.getElementById('chatId').value);
        let content = document.getElementById('messageInput').value;
        if (!content) return;

        let msg = {
            senderId: userId,
            chatId: chatId,
            content: content
        };
        stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
        document.getElementById('messageInput').value = '';
    };
</script>
</body>
</html>
